{% extends 'base.html' %}
{% load static %}

{% block title %}{{ interactive_course.title }} - {{ course.title }}{% endblock %}

{% block extra_css %}
<style>
    .course-player-container {
        background: #1a1a2e;
        min-height: calc(100vh - 200px);
        border-radius: 10px;
        overflow: hidden;
    }
    
    .player-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
    }
    
    .player-iframe-container {
        position: relative;
        width: 100%;
        background: #000;
        min-height: 500px;
    }
    
    .player-controls {
        background: #2d2d44;
        padding: 15px 20px;
        color: white;
    }
    
    .progress-tracker {
        background: rgba(255,255,255,0.1);
        border-radius: 20px;
        height: 8px;
        overflow: hidden;
    }
    
    .progress-tracker .progress-fill {
        background: linear-gradient(90deg, #00c853, #64dd17);
        height: 100%;
        border-radius: 20px;
        transition: width 0.5s ease;
    }
    
    .course-info-panel {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .completion-badge {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 10px 20px;
        border-radius: 50px;
        font-weight: bold;
    }
    
    .slide-tracker {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 10px;
    }
    
    .slide-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(255,255,255,0.3);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .slide-dot.completed {
        background: #00c853;
    }
    
    .slide-dot.current {
        background: #ffc107;
        transform: scale(1.3);
        box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
    }
    
    .slide-dot.locked {
        background: rgba(255,255,255,0.1);
        cursor: not-allowed;
    }
    
    .launch-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 500px;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        padding: 40px;
    }
    
    .launch-icon {
        width: 120px;
        height: 120px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 30px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .rules-list {
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        padding: 20px 25px;
        margin-top: 25px;
        text-align: left;
        max-width: 500px;
    }
    
    .rules-list li {
        margin-bottom: 10px;
        padding-left: 10px;
    }
    
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .status-in-progress {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }
    
    .quiz-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        padding: 25px;
        color: white;
        margin-top: 20px;
    }
    
    .certificate-preview {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        border-radius: 10px;
        padding: 30px;
        color: white;
        text-align: center;
    }
    
    .circular-progress {
        position: relative;
        width: 120px;
        height: 120px;
    }
    
    .circular-progress svg {
        transform: rotate(-90deg);
    }
    
    .circular-progress-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5rem;
        font-weight: bold;
    }

    .fullscreen-controls {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 10000;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px 14px;
        border-radius: 8px;
        display: none;
        align-items: center;
        gap: 10px;
        backdrop-filter: blur(6px);
    }

	    .fullscreen-controls .btn {
	        white-space: nowrap;
	    }

	    #playerContainer:fullscreen,
	    #playerContainer:-webkit-full-screen,
	    #playerContainer:-moz-full-screen,
	    #playerContainer:-ms-fullscreen {
	        width: 100vw;
	        height: 100vh;
	        background: #000;
	    }

	    #playerContainer:fullscreen .course-iframe-container,
	    #playerContainer:-webkit-full-screen .course-iframe-container,
	    #playerContainer:-moz-full-screen .course-iframe-container,
	    #playerContainer:-ms-fullscreen .course-iframe-container {
	        position: absolute;
	        top: 0;
	        right: 0;
	        bottom: 0;
	        left: 0;
	    }

	    #playerContainer:fullscreen #courseIframe,
	    #playerContainer:-webkit-full-screen #courseIframe,
	    #playerContainer:-moz-full-screen #courseIframe,
	    #playerContainer:-ms-fullscreen #courseIframe {
	        width: 100% !important;
	        height: 100% !important;
	        max-width: 100% !important;
	        max-height: 100% !important;
	        border: none !important;
	        display: block;
	        transform-origin: center center;
	    }

	    #playerContainer:fullscreen #slideNavSection,
	    #playerContainer:-webkit-full-screen #slideNavSection,
	    #playerContainer:-moz-full-screen #slideNavSection,
	    #playerContainer:-ms-fullscreen #slideNavSection {
	        position: absolute;
	        left: 0;
	        right: 0;
	        bottom: 0;
	        z-index: 1000;
	    }

	    #playerContainer:fullscreen #slideIndicator,
	    #playerContainer:fullscreen #fullscreenBtn,
	    #playerContainer:-webkit-full-screen #slideIndicator,
	    #playerContainer:-webkit-full-screen #fullscreenBtn,
	    #playerContainer:-moz-full-screen #slideIndicator,
	    #playerContainer:-moz-full-screen #fullscreenBtn,
	    #playerContainer:-ms-fullscreen #slideIndicator,
	    #playerContainer:-ms-fullscreen #fullscreenBtn {
	        z-index: 1001;
	    }

	    #playerContainer:fullscreen::backdrop,
	    #playerContainer:-webkit-full-screen::backdrop {
	        background: #000;
	    }
	</style>
	{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent p-0 mb-2">
                    <li class="breadcrumb-item"><a href="{% url 'courses:dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'courses:course_detail' course.id %}">{{ course.title|truncatewords:3 }}</a></li>
                    <li class="breadcrumb-item active">{{ interactive_course.title|truncatewords:3 }}</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-laptop-code text-primary"></i> {{ interactive_course.title }}
            </h1>
        </div>
        <a href="{% url 'courses:course_detail' course.id %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Course
        </a>
    </div>

    <div class="row">
        <!-- Main Player Area -->
        <div class="col-lg-9">
            <div class="course-player-container shadow">
                <!-- Player Header -->
                <div class="player-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">{{ interactive_course.title }}</h5>
                        <small class="opacity-75">
                            <i class="fas fa-clock"></i> {{ interactive_course.get_duration_display }}
                            <span class="mx-2">|</span>
                            <i class="fas fa-layer-group"></i> {{ interactive_course.total_slides }} slides
                        </small>
                    </div>
                    <div>
                        {% if progress.is_completed %}
                        <span class="completion-badge">
                            <i class="fas fa-check-circle"></i> Completed
                        </span>
                        {% else %}
                        <span class="status-indicator status-in-progress">
                            <i class="fas fa-spinner fa-spin"></i> In Progress - {{ progress.completion_percentage }}%
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Launch Course Section -->
                <div class="launch-section text-white" id="launchSection">
                    <div class="launch-icon">
                        <i class="fas fa-play-circle fa-4x"></i>
                    </div>
                    
                    <h3 class="mb-3">{{ interactive_course.title }}</h3>
                    
                    <div class="mb-4">
                        <span class="badge badge-light px-3 py-2 mr-2">
                            <i class="fas fa-clock"></i> {{ interactive_course.get_duration_display }}
                        </span>
                        <span class="badge badge-light px-3 py-2 mr-2">
                            <i class="fas fa-layer-group"></i> {{ interactive_course.total_slides }} Slides
                        </span>
                        {% if interactive_course.resolution_width %}
                        <span class="badge badge-light px-3 py-2">
                            <i class="fas fa-desktop"></i> {{ interactive_course.resolution_width }}√ó{{ interactive_course.resolution_height }}
                        </span>
                        {% endif %}
                    </div>
                    
                    {% if progress.highest_slide_reached > 0 and not progress.is_completed %}
                    <p class="mb-3 text-warning">
                        <i class="fas fa-bookmark"></i> You've completed {{ progress.highest_slide_reached }} of {{ interactive_course.total_slides }} slides
                    </p>
                    {% endif %}
                    
                    <button class="btn btn-primary btn-lg px-5 py-3" id="launchBtn" onclick="startCourse()">
                        <i class="fas fa-play mr-2"></i> 
                        {% if progress.highest_slide_reached > 0 and not progress.is_completed %}
                            Resume Course
                        {% else %}
                            Start Course
                        {% endif %}
                    </button>
                    
                    <div class="rules-list">
                        <h6 class="font-weight-bold mb-3"><i class="fas fa-exclamation-triangle text-warning"></i> Important Rules</h6>
                        <ul class="mb-0">
                            <li><i class="fas fa-ban text-danger mr-2"></i> <strong>No Skipping:</strong> Progress is tracked automatically as you navigate</li>
                            <li><i class="fas fa-eye text-info mr-2"></i> <strong>Complete Each Slide:</strong> The course tracks when you advance to each slide</li>
                            <li><i class="fas fa-clipboard-check text-success mr-2"></i> <strong>Quiz Required:</strong> Pass the assessment with 80%+ to complete</li>
                            <li><i class="fas fa-certificate text-warning mr-2"></i> <strong>Certificate:</strong> Issued automatically upon successful completion</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Embedded Course Player (hidden until started) -->
                <div id="coursePlayerSection" style="display: none;">
                    <div id="playerContainer" style="position: relative; background: #000;">
                        <div class="course-iframe-container" style="position: relative; background: #000;">
                            <iframe id="courseIframe" 
                                    src="" 
                                    style="width: 100%; height: 70vh; border: none;"
                                    allowfullscreen>
                            </iframe>
                            
                            <!-- Current Slide Indicator -->
                            <div id="slideIndicator" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; z-index: 100;">
                                <i class="fas fa-layer-group"></i> Slide <span id="currentSlideDisplay">1</span> / {{ interactive_course.total_slides }}
                                <span id="slideTimerBadge" class="ml-2 badge badge-warning" style="display: none;">
                                    <i class="fas fa-clock"></i> <span id="slideTimeRemaining">--</span>s
                                </span>
                            </div>
                            
	                            <!-- Fullscreen Button -->
	                            <button id="fullscreenBtn" type="button" onclick="toggleFullscreen()"
	                                    title="Toggle fullscreen (F)"
	                                    style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; z-index: 100;">
	                                <i class="fas fa-expand"></i>
	                            </button>
	                        </div>
                        
                        <!-- Slide Navigation Controls -->
                        <div id="slideNavSection" class="py-3 px-4" style="background: #2d2d44;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-white">
                                    <span id="slideStatusText">
                                        <i class="fas fa-info-circle text-info"></i> 
                                        Watch the content, then click "Next Slide" when ready
                                    </span>
                                </div>
                                <div>
                                    <button id="nextSlideBtn" class="btn btn-success" onclick="advanceToNextSlide()" disabled>
                                        <i class="fas fa-arrow-right mr-2"></i> <span id="nextSlideLabel">Next Slide</span>
                                        <span id="nextSlideLock" class="ml-2 badge badge-light">
                                            <i class="fas fa-lock"></i> <span id="unlockCountdown">--</span>s
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Video for this slide (if present) -->
                        <div id="slideVideoContainer" class="mt-3" style="display:none;">
                            <video id="slideVideo" width="100%" controls style="background: #000; border-radius: 5px;"></video>
                            <div class="small text-muted mt-1">You must watch at least 98% to continue.</div>
                        </div>
                    </div>
                </div>

                <!-- Floating Control Bar (visible in full-screen) -->
                <div id="fullscreenControls" class="fullscreen-controls" aria-live="polite">
                    <button type="button" onclick="exitFullScreen()" class="btn btn-sm btn-secondary">
                        <i class="fas fa-compress"></i> Minimize
                    </button>
                    <button type="button" onclick="enterFullScreen(document.getElementById('playerContainer'))" class="btn btn-sm btn-primary">
                        <i class="fas fa-expand"></i> Maximize
                    </button>
                    <span class="text-white ml-2">
                        Slide <span id="fullscreenSlideNum">1</span> of {{ interactive_course.total_slides }}
                    </span>
                </div>
                
                <!-- Player Controls -->
                <div class="player-controls">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <span class="mr-3">Progress:</span>
                                <div class="progress-tracker flex-grow-1">
                                    <div class="progress-fill" id="progressFill" style="width: {{ progress.completion_percentage }}%;"></div>
                                </div>
                                <span class="ml-3" id="progressText">{{ progress.completion_percentage }}%</span>
                            </div>
                            
                            <!-- Slide Dots -->
                            <div class="slide-tracker" id="slideTracker">
                                {% for i in slide_range %}
                                <div class="slide-dot {% if i <= progress.highest_slide_reached %}completed{% endif %} {% if i == progress.current_slide %}current{% endif %} {% if i > progress.highest_slide_reached|add:1 %}locked{% endif %}" 
                                     title="Slide {{ i }}" data-slide="{{ i }}"></div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6 text-right">
                            <span class="mr-3 small">
                                <i class="fas fa-layer-group"></i> 
                                Slide <span id="currentSlideNum">{{ progress.current_slide|default:0 }}</span> / {{ interactive_course.total_slides }}
                            </span>
                            <span class="small">
                                <i class="fas fa-clock"></i>
                                <span id="timeSpentDisplay">{{ progress.total_time_spent|default:0 }}</span> min
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quiz Section (shown after completing all slides) -->
            {% if progress.highest_slide_reached >= interactive_course.total_slides and not progress.quiz_passed %}
            <div class="quiz-section">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5><i class="fas fa-clipboard-check mr-2"></i> Assessment Required</h5>
                        <p class="mb-0 opacity-75">You've completed all {{ interactive_course.total_slides }} slides! Now take the quiz to earn your certificate.</p>
                    </div>
                    <div class="col-md-4 text-right">
                        <a href="{% url 'quizzes:start_interactive' interactive_course.id %}" class="btn btn-light btn-lg">
                            <i class="fas fa-play mr-2"></i> Start Quiz
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Certificate Section (shown after passing quiz) -->
            {% if progress.quiz_passed %}
            <div class="certificate-preview mt-4">
                <i class="fas fa-award fa-4x mb-3"></i>
                <h4>üéâ Congratulations!</h4>
                <p class="mb-3">You have successfully completed this course with a score of <strong>{{ progress.quiz_score|floatformat:0 }}%</strong></p>
                <a href="{% url 'certificates:my_certificates' %}" class="btn btn-light btn-lg">
                    <i class="fas fa-download mr-2"></i> View Certificate
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Course Info Sidebar -->
        <div class="col-lg-3">
            <!-- Progress Card -->
            <div class="course-info-panel p-4 mb-4">
                <h6 class="font-weight-bold text-primary mb-3">
                    <i class="fas fa-chart-pie"></i> Your Progress
                </h6>
                
                <div class="text-center mb-4">
                    <div class="circular-progress mx-auto">
                        <svg width="120" height="120" viewBox="0 0 120 120">
                            <circle cx="60" cy="60" r="54" fill="none" stroke="#e9ecef" stroke-width="12"/>
                            <circle cx="60" cy="60" r="54" fill="none" 
                                    stroke="{% if progress.is_completed %}#28a745{% else %}#007bff{% endif %}" 
                                    stroke-width="12" stroke-linecap="round"
                                    stroke-dasharray="339.292"
                                    stroke-dashoffset="{{ progress_dashoffset|default:'339.292' }}"
                                    id="progressCircle"/>
                        </svg>
                        <div class="circular-progress-value" id="progressPercent">{{ progress.completion_percentage|default:0 }}%</div>
                    </div>
                </div>
                
                <div class="mb-3 pb-3 border-bottom">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Slides Completed</span>
                        <strong id="slidesCompleted">{{ progress.highest_slide_reached|default:0 }} / {{ interactive_course.total_slides }}</strong>
                    </div>
                </div>
                
                <div class="mb-3 pb-3 border-bottom">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Time Spent</span>
                        <strong id="totalTimeSpent">{{ progress.total_time_spent|default:0 }} min</strong>
                    </div>
                </div>
                
                <div class="mb-3 pb-3 border-bottom">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Status</span>
                        <span class="badge badge-{% if progress.is_completed %}success{% elif progress.current_slide > 0 %}warning{% else %}secondary{% endif %}">
                            {% if progress.is_completed %}Completed{% elif progress.current_slide > 0 %}In Progress{% else %}Not Started{% endif %}
                        </span>
                    </div>
                </div>
                
                {% if progress.quiz_score %}
                <div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Quiz Score</span>
                        <strong class="{% if progress.quiz_passed %}text-success{% else %}text-danger{% endif %}">
                            {{ progress.quiz_score|floatformat:0 }}%
                            {% if progress.quiz_passed %}<i class="fas fa-check-circle ml-1"></i>{% endif %}
                        </strong>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Course Requirements -->
            <div class="course-info-panel p-4 mb-4">
                <h6 class="font-weight-bold text-warning mb-3">
                    <i class="fas fa-clipboard-list"></i> Requirements
                </h6>
                <ul class="list-unstyled mb-0 small">
                    <li class="mb-2 d-flex align-items-start">
                        <i class="fas fa-{% if progress.highest_slide_reached >= interactive_course.total_slides %}check-circle text-success{% else %}circle text-muted{% endif %} mr-2 mt-1"></i>
                        <span>Complete all {{ interactive_course.total_slides }} slides</span>
                    </li>
                    <li class="mb-2 d-flex align-items-start">
                        <i class="fas fa-{% if progress.quiz_passed %}check-circle text-success{% else %}circle text-muted{% endif %} mr-2 mt-1"></i>
                        <span>Pass quiz with 80%+</span>
                    </li>
                    <li class="d-flex align-items-start">
                        <i class="fas fa-{% if progress.quiz_passed %}check-circle text-success{% else %}circle text-muted{% endif %} mr-2 mt-1"></i>
                        <span>Earn certificate</span>
                    </li>
                </ul>
            </div>
            
            <!-- Tips -->
            <div class="course-info-panel p-4">
                <h6 class="font-weight-bold text-info mb-3">
                    <i class="fas fa-lightbulb"></i> Tips
                </h6>
                <ul class="small mb-0 pl-3">
                    <li class="mb-2">Complete slides in order - no skipping!</li>
                    <li class="mb-2">Your progress saves automatically</li>
                    <li class="mb-2">Take notes for the quiz</li>
                    <li>You can resume anytime</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Completion Modal -->
<div class="modal fade" id="completionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-check-circle fa-5x text-success"></i>
                </div>
                <h4 class="text-success">All Slides Completed!</h4>
                <p class="text-muted">Great work! You've completed all {{ interactive_course.total_slides }} slides. Now take the quiz to earn your certificate.</p>
                <a href="{% url 'quizzes:start_interactive' interactive_course.id %}" class="btn btn-success btn-lg">
                    <i class="fas fa-clipboard-check mr-2"></i> Take Quiz Now
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SCORM API Wrapper - Must load before course -->
<script src="{% static 'js/scorm_api.js' %}"></script>

<script>
// --- Video Progress Lock Logic ---
// Placeholder: Array of video URLs for each slide (1-based index)
// Replace these URLs with your actual video URLs for each slide
const slideVideoUrls = [
    null, // index 0 unused (slides start at 1)
    'URL_TO_VIDEO_1',
    'URL_TO_VIDEO_2',
    'URL_TO_VIDEO_3',
    // ... add more URLs for each slide
];

function loadSlideVideo(videoUrl) {
    const videoContainer = document.getElementById('slideVideoContainer');
    const oldVideo = document.getElementById('slideVideo');
    const nextBtn = document.getElementById('nextSlideBtn');
    disableNavButtons(true);
    // Remove previous event listeners by replacing the video element
    const newVideo = oldVideo.cloneNode(true);
    newVideo.removeAttribute('src');
    newVideo.load();
    oldVideo.parentNode.replaceChild(newVideo, oldVideo);
    // Now newVideo is the fresh element
    newVideo.currentTime = 0;
    let unlocked = false;
    canAdvance = false;
    console.log('[LMS] loadSlideVideo called with videoUrl:', videoUrl);
    if (!videoUrl) {
        videoContainer.style.display = 'none';
        nextBtn.disabled = true;
        console.log('[LMS] No video for this slide. Hiding video container and disabling Next Slide.');
        return;
    }
    videoContainer.style.display = 'block';
    newVideo.src = videoUrl;
    newVideo.load();
    nextBtn.disabled = true;
    newVideo.addEventListener('timeupdate', function unlockOnProgress() {
        // Debug log for timeupdate
        console.log('[LMS] timeupdate:', newVideo.currentTime, '/', newVideo.duration, 'unlocked:', unlocked);
        if (newVideo.duration > 0 && newVideo.currentTime / newVideo.duration >= 0.98 && !unlocked) {
            nextBtn.disabled = false;
            unlocked = true;
            canAdvance = true;
            disableNavButtons(false);
            console.log('[LMS] Video watched >= 98%. Next Slide enabled.');
        }
        if (newVideo.duration > 0 && newVideo.currentTime / newVideo.duration < 0.98 && unlocked) {
            nextBtn.disabled = true;
            unlocked = false;
            canAdvance = false;
            disableNavButtons(true);
            console.log('[LMS] Video progress dropped below 98%. Next Slide disabled.');
        }
    });
    newVideo.addEventListener('ended', function() {
        nextBtn.disabled = false;
        unlocked = true;
        canAdvance = true;
        disableNavButtons(false);
        console.log('[LMS] Video ended. Next Slide enabled.');
    });
    // Ensure global reference is updated if needed elsewhere
    window.slideVideo = newVideo;
}

// Disable or enable all navigation buttons except Next Slide
function disableNavButtons(disable) {
    // Example: disable all buttons with class 'nav-btn' except #nextSlideBtn
    document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.id !== 'nextSlideBtn') btn.disabled = disable;
    });
}

// Example: Call loadSlideVideo('URL_TO_VIDEO') when a slide loads with a video
// Integrate this with your slide loading logic as needed.
/**
 * Hybrid Progress Tracking for Captivate Courses
 * 
 * This approach combines:
 * 1. SCORM API - Captures slide changes if Captivate reports them
 * 2. Time-based unlock - User can manually advance after minimum time on each slide
 * 3. Resume support - Users can continue from where they left off
 */

// Course configuration
const interactiveId = {{ interactive_course.id }};
const totalSlides = {{ interactive_course.total_slides }};
const courseDurationMinutes = {{ interactive_course.duration_minutes|default:30 }};
const csrfToken = '{{ csrf_token }}';
const launchUrl = '{{ launch_url }}';
const progressUpdateUrl = '{% url "content:update_interactive_progress" interactive_course.id %}';

// Calculate minimum time per slide (in seconds)
// Based on course duration, minimum 20 seconds per slide
const minTimePerSlide = Math.max(20, Math.floor((courseDurationMinutes * 60) / totalSlides));

// Configure SCORM API wrapper
window.SCORM_CONFIG = {
    interactiveId: interactiveId,
    csrfToken: csrfToken,
    progressUrl: progressUpdateUrl,
    totalSlides: totalSlides,
    debug: true
};

// Progress state (loaded from server)
let currentSlide = {{ progress.current_slide|default:0 }};
let highestSlideReached = {{ progress.highest_slide_reached|default:0 }};
let completionPercentage = {{ progress.completion_percentage|default:0 }};
let isCompleted = {{ progress.is_completed|yesno:"true,false" }};
let contentCompleted = {{ progress.content_completed|yesno:"true,false" }};
let totalTimeSpent = {{ progress.total_time_spent|default:0 }};

// Session state
let sessionStartTime = null;
let courseLaunched = false;
let timeTracker = null;
let slideTimer = null;
let slideTimeRemaining = 0;
let canAdvance = false;
let pendingCaptivateTargetSlide = null;
let pendingAdvanceInFlight = false;
let lastKnownCaptivateSlide = 0;
let pendingCaptivateTimer = null;

function setPendingCaptivateTarget(slideNumber) {
    pendingCaptivateTargetSlide = slideNumber;
    if (pendingCaptivateTimer) clearTimeout(pendingCaptivateTimer);
    pendingCaptivateTimer = setTimeout(() => {
        pendingCaptivateTargetSlide = null;
        pendingCaptivateTimer = null;
    }, 3000);
}

function enterFullScreen(element) {
    if (!element) return;
    if (element.requestFullscreen) return element.requestFullscreen();
    if (element.mozRequestFullScreen) return element.mozRequestFullScreen();
    if (element.webkitRequestFullscreen) return element.webkitRequestFullscreen();
    if (element.msRequestFullscreen) return element.msRequestFullscreen();
}

function exitFullScreen() {
    if (document.exitFullscreen) return document.exitFullscreen();
    if (document.mozCancelFullScreen) return document.mozCancelFullScreen();
    if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
    if (document.msExitFullscreen) return document.msExitFullscreen();
}

function getFullscreenElement() {
    return document.fullscreenElement ||
        document.webkitFullscreenElement ||
        document.mozFullScreenElement ||
        document.msFullscreenElement;
}

function getCaptivateResolution() {
    const width = {{ interactive_course.resolution_width|default:1280 }};
    const height = {{ interactive_course.resolution_height|default:720 }};
    return {
        width: Math.max(1, parseInt(width, 10) || 1280),
        height: Math.max(1, parseInt(height, 10) || 720)
    };
}

function findCaptivateContainer(iframeDoc) {
    if (!iframeDoc) return null;
    return (
        iframeDoc.getElementById('cpDocument') ||
        iframeDoc.getElementById('Slide') ||
        iframeDoc.querySelector('.cp-movie') ||
        iframeDoc.querySelector('.slide') ||
        iframeDoc.querySelector('[id^="Slide"]') ||
        iframeDoc.body.firstElementChild ||
        null
    );
}

function scaleCaptivateToFullscreen(enable) {
    const iframe = document.getElementById('courseIframe');
    if (!iframe) return;

    let iframeDoc = null;
    try {
        iframeDoc = iframe.contentWindow && iframe.contentWindow.document;
    } catch (e) {
        iframeDoc = null;
    }

    const resolution = getCaptivateResolution();
    if (enable) {
        const viewportWidth = window.innerWidth || document.documentElement.clientWidth || resolution.width;
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight || resolution.height;
        const scaleX = viewportWidth / resolution.width;
        const scaleY = viewportHeight / resolution.height;
        const scale = Math.min(scaleX, scaleY);

        if (iframeDoc && iframeDoc.body) {
            const container = findCaptivateContainer(iframeDoc);
            const target = container || iframeDoc.body;
            if (!target.dataset.lmsOriginalTransform) {
                target.dataset.lmsOriginalTransform = target.style.transform || '';
                target.dataset.lmsOriginalPosition = target.style.position || '';
                target.dataset.lmsOriginalTop = target.style.top || '';
                target.dataset.lmsOriginalLeft = target.style.left || '';
                target.dataset.lmsOriginalMarginTop = target.style.marginTop || '';
                target.dataset.lmsOriginalMarginLeft = target.style.marginLeft || '';
            }

            iframeDoc.body.style.overflow = 'hidden';
            target.style.transform = 'scale(' + scale + ')';
            target.style.transformOrigin = 'top left';
            target.style.position = 'absolute';
            target.style.top = '50%';
            target.style.left = '50%';
            target.style.marginTop = '-' + ((resolution.height * scale) / 2) + 'px';
            target.style.marginLeft = '-' + ((resolution.width * scale) / 2) + 'px';
        } else {
            iframe.style.transform = 'scale(' + scale + ')';
            iframe.style.transformOrigin = 'center center';
        }
    } else {
        if (iframeDoc && iframeDoc.body) {
            const container = findCaptivateContainer(iframeDoc);
            const target = container || iframeDoc.body;
            if (target && target.dataset.lmsOriginalTransform !== undefined) {
                target.style.transform = target.dataset.lmsOriginalTransform;
                target.style.position = target.dataset.lmsOriginalPosition;
                target.style.top = target.dataset.lmsOriginalTop;
                target.style.left = target.dataset.lmsOriginalLeft;
                target.style.marginTop = target.dataset.lmsOriginalMarginTop;
                target.style.marginLeft = target.dataset.lmsOriginalMarginLeft;
            } else if (target) {
                target.style.transform = '';
                target.style.position = '';
                target.style.top = '';
                target.style.left = '';
                target.style.marginTop = '';
                target.style.marginLeft = '';
            }
            iframeDoc.body.style.overflow = '';
        }
        iframe.style.transform = '';
        iframe.style.transformOrigin = '';
    }
}

// Start the course - show iframe and begin tracking
function startCourse() {
    courseLaunched = true;
    sessionStartTime = Date.now();
    document.getElementById('launchSection').style.display = 'none';
    document.getElementById('coursePlayerSection').style.display = 'block';
    
    // Resume from last completed slide (never beyond highestSlideReached)
    currentSlide = Math.max(1, Math.min(totalSlides, highestSlideReached || 1));
    
    // Load the Captivate course
    const iframe = document.getElementById('courseIframe');
    iframe.src = launchUrl;

    // Auto-enter fullscreen (works because startCourse is user-initiated)
    try {
        const playerContainer = document.getElementById('playerContainer');
        enterFullScreen(playerContainer);
    } catch (e) {
        // Fullscreen may be blocked by browser policy; user can use the button.
    }
    
    // Inject SCORM API and navigate to resume slide when iframe loads
    iframe.onload = function() {
        injectScormApiToIframe(iframe);
        setupCaptivateNavigationGuard(iframe);

        try {
            const scaleMode = '{{ interactive_course.scale_mode|default:"showAll"|escapejs }}';
            const iframeWindow = iframe.contentWindow;
            if (iframeWindow && iframeWindow.cp && iframeWindow.cp.model && iframeWindow.cp.model.data) {
                iframeWindow.cp.model.data.scaleMode = scaleMode;
            } else if (iframeWindow) {
                iframeWindow.scaleMode = scaleMode;
            }
        } catch (e) {
            // Ignore cross-origin access errors.
        }

        if (getFullscreenElement()) {
            setTimeout(function() {
                scaleCaptivateToFullscreen(true);
            }, 200);
        }
        
        // If resuming, navigate Captivate to the saved slide after a short delay
        // (Captivate needs time to initialize)
        if (highestSlideReached > 1) {
            setTimeout(function() {
                goToCaptivateSlide(currentSlide);
                console.log('[LMS] Navigating Captivate to resume slide:', currentSlide);
                // Ensure unlock logic is applied for the resumed slide
                startSlideTimer(slideVideoUrls[currentSlide] || null);
            }, 1500);
        } else {
            // If not resuming, start unlock logic for slide 1
            startSlideTimer(slideVideoUrls[currentSlide] || null);
        }
    };
    startTimeTracking();
    updateProgressUI();
    updateSlideDisplay(currentSlide);

    // Persist slide start (server enforces min time from first start)
    saveProgress({ current_slide: currentSlide });
    
    // Show appropriate message
    if (highestSlideReached > 0) {
        showToast('üìö Resuming Course', 
            `You've completed ${highestSlideReached} of ${totalSlides} slides. The course will jump to slide ${currentSlide}.`, 
            'info');
    } else {
        showToast('Course Started', 'Watch the content in the Captivate player. Use the "Next Slide" button below to track your progress.', 'info');
    }
}

// Start timer for current slide
function startSlideTimer(videoUrl) {
    if (slideTimer) {
        clearInterval(slideTimer);
    }
    const nextBtn = document.getElementById('nextSlideBtn');
    const lockBadge = document.getElementById('nextSlideLock');
    const statusText = document.getElementById('slideStatusText');

    setNextButtonLabel();
    
    // Check if this slide was already completed (currentSlide <= highestSlideReached means it's done)
    if (currentSlide <= highestSlideReached && currentSlide < totalSlides) {
        // This slide is already completed - can advance immediately to next
        canAdvance = true;
        nextBtn.disabled = false;
        lockBadge.style.display = 'none';
        statusText.innerHTML = '<i class="fas fa-hourglass-half text-warning"></i> Watch the video. Next slide unlocks after 98% watched.';
        return;
    }
    
    // Check if we've reached the last slide AND it's already completed
    if (currentSlide >= totalSlides && highestSlideReached >= totalSlides) {
        canAdvance = false;
        nextBtn.disabled = true;
        lockBadge.style.display = 'none';
        statusText.innerHTML = '<i class="fas fa-trophy text-warning"></i> All slides completed! Take the quiz to earn your certificate.';
        return;
    }
    
    // Check if we're on the last slide but haven't completed it yet
    if (currentSlide >= totalSlides) {
        canAdvance = false;
        nextBtn.disabled = true;
        lockBadge.style.display = 'none';
        statusText.innerHTML = '<i class="fas fa-flag-checkered text-success"></i> Final slide! Watch to unlock <strong>Finish</strong>.';
        
        // Unlock after timer (completion requires explicit click)
        slideTimeRemaining = minTimePerSlide;
        document.getElementById('slideTimerBadge').style.display = 'inline';
        document.getElementById('slideTimeRemaining').textContent = slideTimeRemaining;
        
        slideTimer = setInterval(function() {
            slideTimeRemaining--;
            document.getElementById('slideTimeRemaining').textContent = Math.max(0, slideTimeRemaining);
            
            if (slideTimeRemaining <= 0) {
                clearInterval(slideTimer);
                document.getElementById('slideTimerBadge').style.display = 'none';
                slideTimer = null;
                canAdvance = true;
                nextBtn.disabled = false;
                statusText.innerHTML = '<i class="fas fa-unlock text-success"></i> Final slide unlocked! Click <strong>Finish</strong> to save completion.';
                showToast('‚úì Final Slide Unlocked', 'Click "Finish" to complete the content.', 'success');
            }
        }, 1000);
        return;
    }
    
    // New slide that hasn't been completed - start countdown
    canAdvance = false;
    nextBtn.disabled = true;
    lockBadge.style.display = 'inline';
    slideTimeRemaining = minTimePerSlide;
    
    document.getElementById('unlockCountdown').textContent = slideTimeRemaining;
    document.getElementById('slideTimerBadge').style.display = 'inline';
    document.getElementById('slideTimeRemaining').textContent = slideTimeRemaining;
    statusText.innerHTML = '<i class="fas fa-hourglass-half text-warning"></i> Watch the content. Next slide unlocks in <strong>' + slideTimeRemaining + '</strong> seconds...';
    
    // Start countdown
    slideTimer = setInterval(function() {
        slideTimeRemaining--;
        document.getElementById('unlockCountdown').textContent = Math.max(0, slideTimeRemaining);
        document.getElementById('slideTimeRemaining').textContent = Math.max(0, slideTimeRemaining);
        
        if (slideTimeRemaining <= 0) {
            clearInterval(slideTimer);
            slideTimer = null;
            
            document.getElementById('slideTimerBadge').style.display = 'none';
            
            // Unlock the button (completion still requires explicit click + backend save)
            canAdvance = true;
            nextBtn.disabled = false;
            lockBadge.style.display = 'none';
            statusText.innerHTML = '<i class="fas fa-unlock text-success"></i> Slide unlocked! Click <strong>Next Slide</strong> to continue.';
            
            showToast('‚úì Slide Unlocked', 'Click "Next Slide" to continue.', 'success');
        } else {
            statusText.innerHTML = '<i class="fas fa-hourglass-half text-warning"></i> Watch the content. Next slide unlocks in <strong>' + slideTimeRemaining + '</strong> seconds...';
        }
    }, 1000);
}

// Advance to next slide
function advanceToNextSlide() {
    if (pendingAdvanceInFlight) return;

    // Check if we can advance
    if (!canAdvance) {
        showToast('‚è≥ Please Wait', 'Slide is still locked. Finish the countdown to unlock.', 'warning');
        return;
    }
    
    const isCurrentSlideCompleted = currentSlide <= highestSlideReached;

    // Incomplete slide: require explicit completion + server confirmation.
    if (!isCurrentSlideCompleted) {
        pendingAdvanceInFlight = true;
        const nextSlide = Math.min(totalSlides, currentSlide + 1);
        setPendingCaptivateTarget(nextSlide);

        saveProgress({
            slide_completed: currentSlide,
            current_slide: nextSlide
        })
        .then(({ ok, data }) => {
            pendingAdvanceInFlight = false;
            if (!ok || !data.success) {
                handleProgressError(data);
                pendingCaptivateTargetSlide = null;
                return;
            }

            syncFromServer(data);

            if (currentSlide >= totalSlides && contentCompleted) {
                showToast('üéâ Content Complete!', 'All slides finished! Take the quiz to earn your certificate.', 'success');
                showCompletionModal();
                pendingCaptivateTargetSlide = null;
                return;
            }

            triggerCaptivateNextSlide();
            startSlideTimer();
        })
        .catch(err => {
            pendingAdvanceInFlight = false;
            pendingCaptivateTargetSlide = null;
            console.error('[LMS] Advance failed:', err);
            showToast('‚ö†Ô∏è Save Failed', 'Could not save progress. Please try again.', 'error');
        });

        return;
    }

    // Completed slide: allow navigation within unlocked range.
    if (currentSlide >= totalSlides) {
        showToast('Course Complete', 'You have completed all slides! Take the quiz now.', 'success');
        return;
    }

    const nextSlide = currentSlide + 1;
    if (nextSlide > highestSlideReached + 1) {
        showToast('üîí Slide Locked', 'Complete previous slides to unlock.', 'warning');
        return;
    }

    currentSlide = nextSlide;
    updateProgressUI();
    updateSlideDisplay(currentSlide);
    setNextButtonLabel();
    saveProgress({ current_slide: currentSlide });

    setPendingCaptivateTarget(currentSlide);
    triggerCaptivateNextSlide();
    startSlideTimer();
}

/**
 * Trigger the next slide in the Captivate course iframe
 * Captivate exposes several methods to control navigation:
 * - cpCmndNext (go to next slide)
 * - cpCmndGotoSlide (go to specific slide)
 * - cpCmndResume (resume playback)
 */
function triggerCaptivateNextSlide() {
    const iframe = document.getElementById('courseIframe');
    if (!iframe) return;
    
    try {
        const iframeWindow = iframe.contentWindow;
        
        // Method 1: Try Captivate's cpCmndNext variable (most common)
        if (typeof iframeWindow.cpCmndNext !== 'undefined') {
            iframeWindow.cpCmndNext = true;
            console.log('[LMS] Triggered cpCmndNext');
            return;
        }
        
        // Method 2: Try Captivate's cpAPIInterface (newer versions)
        if (iframeWindow.cpAPIInterface && typeof iframeWindow.cpAPIInterface.next === 'function') {
            iframeWindow.cpAPIInterface.next();
            console.log('[LMS] Triggered cpAPIInterface.next()');
            return;
        }
        
        // Method 3: Try cpCmndGotoSlide to go to specific slide
        if (typeof iframeWindow.cpCmndGotoSlide !== 'undefined') {
            iframeWindow.cpCmndGotoSlide = Math.max(0, currentSlide - 1);
            setTimeout(() => { try { iframeWindow.cpCmndGotoSlide = currentSlide; } catch (e) {} }, 200);
            console.log('[LMS] Triggered cpCmndGotoSlide for slide', currentSlide);
            return;
        }
        
        // Method 4: Try to find and click the next button in Captivate
        const nextBtn = iframeWindow.document.querySelector('[id*="next"], [id*="Next"], .cp-next, [class*="next"]');
        if (nextBtn) {
            nextBtn.click();
            console.log('[LMS] Clicked Captivate next button');
            return;
        }
        
        // Method 5: Try postMessage API
        iframeWindow.postMessage({ type: 'cpNavigate', action: 'next', slide: currentSlide }, '*');
        console.log('[LMS] Sent postMessage to navigate');
        
        // Method 6: Try invoking Captivate's movie control
        if (iframeWindow.cp && iframeWindow.cp.movie) {
            iframeWindow.cp.movie.cpCmndNext = true;
            console.log('[LMS] Triggered cp.movie.cpCmndNext');
            return;
        }
        
        // Method 7: Try setting slide via cpInfoCurrentSlide
        if (typeof iframeWindow.cpInfoCurrentSlide !== 'undefined') {
            // Read current and set next
            const captivateCurrentSlide = iframeWindow.cpInfoCurrentSlide;
            if (iframeWindow.cpCmndGotoSlide !== undefined) {
                iframeWindow.cpCmndGotoSlide = captivateCurrentSlide + 1;
            }
        }
        
    } catch (e) {
        console.warn('[LMS] Could not control Captivate directly (cross-origin):', e.message);
        // Try postMessage as fallback
        try {
            iframe.contentWindow.postMessage({ 
                type: 'lmsNavigate', 
                action: 'nextSlide',
                targetSlide: currentSlide 
            }, '*');
        } catch (e2) {
            console.warn('[LMS] PostMessage also failed:', e2.message);
        }
    }
}

/**
 * Best-effort guard against Captivate navigation APIs.
 * (Still backed by backend validation + polling enforcement.)
 */
function setupCaptivateNavigationGuard(iframe) {
    try {
        const w = iframe.contentWindow;
        if (!w) return;

        // Try to mitigate in-iframe back/forward (same-origin only).
        try {
            w.history && w.history.pushState && w.history.pushState(null, w.document.title, w.location.href);
            w.addEventListener && w.addEventListener('popstate', function() {
                try { w.history.pushState(null, w.document.title, w.location.href); } catch (e) {}
            });
        } catch (e) {}

        const api = w.cpAPIInterface;
        if (!api || api.__lmsNavGuardInstalled) return;
        api.__lmsNavGuardInstalled = true;

        const originalNext = (typeof api.next === 'function') ? api.next.bind(api) : null;
        const originalPrev = (typeof api.previous === 'function') ? api.previous.bind(api) : null;
        const originalGoto = (typeof api.gotoSlide === 'function') ? api.gotoSlide.bind(api) : null;

        function isAllowedTargetSlide(targetSlideOneBased) {
            if (targetSlideOneBased < 1 || targetSlideOneBased > totalSlides) return false;
            if (targetSlideOneBased === currentSlide) return true;
            if (targetSlideOneBased <= highestSlideReached) return true; // completed slides
            if (targetSlideOneBased === highestSlideReached + 1) {
                return !!(pendingCaptivateTargetSlide && targetSlideOneBased === pendingCaptivateTargetSlide);
            }
            return false;
        }

        api.next = function() {
            const captivateCurrent = (typeof w.cpInfoCurrentSlide !== 'undefined')
                ? (parseInt(w.cpInfoCurrentSlide, 10) + 1)
                : (currentSlide || 1);
            const target = captivateCurrent + 1;
            if (!canAdvance || !isAllowedTargetSlide(target)) {
                showToast('üîí Navigation Blocked', 'Use the "Next Slide" button to continue.', 'warning');
                goToCaptivateSlide(currentSlide || 1);
                return false;
            }
            return originalNext ? originalNext() : true;
        };

        api.previous = function() {
            const captivateCurrent = (typeof w.cpInfoCurrentSlide !== 'undefined')
                ? (parseInt(w.cpInfoCurrentSlide, 10) + 1)
                : (currentSlide || 1);
            const target = Math.max(1, captivateCurrent - 1);
            if (!isAllowedTargetSlide(target)) {
                goToCaptivateSlide(currentSlide || 1);
                return false;
            }
            return originalPrev ? originalPrev() : true;
        };

        api.gotoSlide = function(index) {
            const target = parseInt(index, 10) + 1; // Captivate commonly uses 0-based slide index here
            if (!isAllowedTargetSlide(target)) {
                showToast('üîí Slide Locked', 'Complete previous slides to unlock.', 'warning');
                goToCaptivateSlide(currentSlide || 1);
                return false;
            }
            return originalGoto ? originalGoto(index) : true;
        };
    } catch (e) {
        // Best-effort only; polling + backend enforcement still apply.
    }
}

/**
 * Go to a specific slide in Captivate
 */
function goToCaptivateSlide(slideNumber) {
    const iframe = document.getElementById('courseIframe');
    if (!iframe) return;
    
    try {
        const iframeWindow = iframe.contentWindow;
        
        // Captivate often uses 0-based indexing internally, but this varies by build.
        const captivateSlideIndex0 = Math.max(0, slideNumber - 1);
        
        // Try cpCmndGotoSlide (0-index first, then 1-index fallback)
        if (typeof iframeWindow.cpCmndGotoSlide !== 'undefined') {
            iframeWindow.cpCmndGotoSlide = captivateSlideIndex0;
            setTimeout(() => { try { iframeWindow.cpCmndGotoSlide = slideNumber; } catch (e) {} }, 200);
            console.log('[LMS] Going to slide', slideNumber);
            return;
        }
        
        // Try cpAPIInterface
        if (iframeWindow.cpAPIInterface && typeof iframeWindow.cpAPIInterface.gotoSlide === 'function') {
            iframeWindow.cpAPIInterface.gotoSlide(captivateSlideIndex0);
            return;
        }
        
    } catch (e) {
        console.warn('[LMS] Could not navigate to slide:', e.message);
    }
}

function setNextButtonLabel() {
    const btn = document.getElementById('nextSlideBtn');
    if (!btn) return;

    const icon = btn.querySelector('i');
    const labelEl = document.getElementById('nextSlideLabel');
    const label = (currentSlide >= totalSlides) ? 'Finish' : 'Next Slide';
    if (icon) icon.className = (currentSlide >= totalSlides) ? 'fas fa-flag-checkered mr-2' : 'fas fa-arrow-right mr-2';
    if (labelEl) labelEl.textContent = label;
}

// Inject SCORM API into the iframe's content window
function injectScormApiToIframe(iframe) {
    try {
        const iframeWindow = iframe.contentWindow;
        iframeWindow.API = createScormApi();
        iframeWindow.API_1484_11 = createScorm2004Api();
        console.log('[LMS] SCORM API injected into iframe');
    } catch (e) {
        console.warn('[LMS] Could not inject SCORM API directly (cross-origin). Using parent window API.');
    }
}

// Create SCORM 1.2 API object
function createScormApi() {
    return {
        LMSInitialize: function(param) {
            console.log('[SCORM 1.2] LMSInitialize');
            return 'true';
        },
        LMSFinish: function(param) {
            console.log('[SCORM 1.2] LMSFinish');
            onCourseFinished();
            return 'true';
        },
        LMSGetValue: function(element) {
            console.log('[SCORM 1.2] LMSGetValue:', element);
            return getScormValue(element);
        },
        LMSSetValue: function(element, value) {
            console.log('[SCORM 1.2] LMSSetValue:', element, '=', value);
            return setScormValue(element, value);
        },
        LMSCommit: function(param) {
            console.log('[SCORM 1.2] LMSCommit');
            saveProgress();
            return 'true';
        },
        LMSGetLastError: function() { return '0'; },
        LMSGetErrorString: function(code) { return 'No error'; },
        LMSGetDiagnostic: function(code) { return 'No error'; }
    };
}

// Create SCORM 2004 API object
function createScorm2004Api() {
    return {
        Initialize: function(param) {
            console.log('[SCORM 2004] Initialize');
            return 'true';
        },
        Terminate: function(param) {
            console.log('[SCORM 2004] Terminate');
            onCourseFinished();
            return 'true';
        },
        GetValue: function(element) {
            console.log('[SCORM 2004] GetValue:', element);
            return getScormValue(element);
        },
        SetValue: function(element, value) {
            console.log('[SCORM 2004] SetValue:', element, '=', value);
            return setScormValue(element, value);
        },
        Commit: function(param) {
            console.log('[SCORM 2004] Commit');
            saveProgress();
            return 'true';
        },
        GetLastError: function() { return '0'; },
        GetErrorString: function(code) { return 'No error'; },
        GetDiagnostic: function(code) { return 'No error'; }
    };
}

// SCORM data storage - initialized with saved progress from server
// These values are returned to Captivate when it calls LMSGetValue
const savedSlide = {{ progress.highest_slide_reached|default:0 }};
const savedSuspendData = '{{ progress.scorm_suspend_data|default:""|escapejs }}';

const scormData = {
    // SCORM 1.2 elements
    'cmi.core.lesson_location': savedSlide > 0 ? String(savedSlide) : '',
    'cmi.core.lesson_status': '{% if progress.content_completed %}completed{% elif progress.highest_slide_reached > 0 %}incomplete{% else %}not attempted{% endif %}',
    'cmi.core.score.raw': '{{ progress.quiz_score|default:"" }}',
    'cmi.core.entry': savedSlide > 0 ? 'resume' : 'ab-initio',
    'cmi.core.exit': '',
    'cmi.core.credit': 'credit',
    'cmi.core.lesson_mode': 'normal',
    'cmi.suspend_data': savedSuspendData,
    'cmi.launch_data': '',
    
    // SCORM 2004 elements
    'cmi.location': savedSlide > 0 ? String(savedSlide) : '',
    'cmi.completion_status': '{% if progress.content_completed %}completed{% elif progress.highest_slide_reached > 0 %}incomplete{% else %}not attempted{% endif %}',
    'cmi.entry': savedSlide > 0 ? 'resume' : 'ab-initio',
    'cmi.exit': '',
    'cmi.mode': 'normal',
    'cmi.credit': 'credit'
};

// Get SCORM value - returns saved progress to Captivate
function getScormValue(element) {
    const value = scormData[element];
    console.log('[SCORM] GetValue:', element, '=', value);
    return value !== undefined ? String(value) : '';
}

// Set SCORM value - capture slide changes from Captivate
function setScormValue(element, value) {
    scormData[element] = value;
    
    // Track lesson_location (slide number) from SCORM
    if (element === 'cmi.core.lesson_location' || element === 'cmi.location') {
        const slideNum = parseSlideNumber(value);
        if (slideNum > 0) {
            onScormSlideChange(slideNum);
        }
    }
    
    // Track completion status
    if (element === 'cmi.core.lesson_status' || element === 'cmi.completion_status') {
        if (value === 'completed' || value === 'passed') {
            onCourseCompleted();
        }
    }
    
    // Track suspend_data (Captivate stores its resume state here)
    if (element === 'cmi.suspend_data') {
        // Save suspend_data to server for resume
        saveSuspendData(value);
    }
    
    // Track exit status
    if (element === 'cmi.core.exit' || element === 'cmi.exit') {
        if (value === 'suspend') {
            // User wants to resume later - save state
            saveProgress();
        }
    }
    
    return 'true';
}

// Parse slide number from various formats
function parseSlideNumber(location) {
    if (!location) return 0;
    
    if (/^\d+$/.test(String(location))) {
        return parseInt(location, 10);
    }
    
    let match = String(location).match(/slide[_]?(\d+)/i);
    if (match) return parseInt(match[1], 10);
    
    match = String(location).match(/m\d+s(\d+)/i);
    if (match) return parseInt(match[1], 10);
    
    match = String(location).match(/frame[_]?(\d+)/i);
    if (match) return parseInt(match[1], 10);
    
    match = String(location).match(/(\d+)/);
    if (match) return parseInt(match[1], 10);
    
    return 0;
}

// Called when SCORM reports a slide change (auto-advance)
function onScormSlideChange(slideNum) {
    console.log('[LMS] SCORM slide change detected:', slideNum);
    if (slideNum < 1 || slideNum > totalSlides) return;

    // Block future slide access.
    if (slideNum > highestSlideReached + 1) {
        console.warn('[LMS] Captivate tried to skip ahead to slide', slideNum);
        goToCaptivateSlide(currentSlide || (highestSlideReached + 1));
        showToast('üîí Slide Locked', 'Complete previous slides to unlock.', 'warning');
        return;
    }

    if (slideNum === currentSlide) return;

    // If we're in the middle of a user-initiated forward navigation, ignore transient reports
    // of the prior slide to avoid "rewind" / flicker.
    if (pendingCaptivateTargetSlide && slideNum < pendingCaptivateTargetSlide) {
        return;
    }

    // Allow revisiting already-completed slides (forward/back).
    if (slideNum <= highestSlideReached) {
        currentSlide = slideNum;
        updateProgressUI();
        updateSlideDisplay(slideNum);
        setNextButtonLabel();
        saveProgress({ current_slide: currentSlide });
        startSlideTimer();
        return;
    }

    // Only allow entering the next unlocked (incomplete) slide when initiated by the LMS button.
    if (slideNum === highestSlideReached + 1) {
        if (!pendingCaptivateTargetSlide || slideNum !== pendingCaptivateTargetSlide) {
            goToCaptivateSlide(currentSlide);
            showToast('üîí Navigation Blocked', 'Use the "Next Slide" button to continue.', 'warning');
            return;
        }

        pendingCaptivateTargetSlide = null;
        currentSlide = slideNum;
        updateProgressUI();
        updateSlideDisplay(slideNum);
        setNextButtonLabel();
        saveProgress({ current_slide: currentSlide });
        startSlideTimer();
    }
}

// Called when course reports completion
function onCourseCompleted() {
    console.log('[LMS] Course completion detected');
    contentCompleted = true;
    updateProgressUI();
    saveProgress({ content_completed: true });
}

// Called when course finishes
function onCourseFinished() {
    console.log('[LMS] Course finished signal received');
    saveProgress();
}

// Update the slide display indicator
function updateSlideDisplay(slideNum) {
    document.getElementById('currentSlideDisplay').textContent = slideNum;
    document.getElementById('currentSlideNum').textContent = slideNum;
    const fsNum = document.getElementById('fullscreenSlideNum');
    if (fsNum) fsNum.textContent = slideNum;
}

// Start time tracking
function startTimeTracking() {
    timeTracker = setInterval(function() {
        totalTimeSpent++;
        
        if (totalTimeSpent % 60 === 0) {
            const minutes = Math.floor(totalTimeSpent / 60);
            document.getElementById('totalTimeSpent').textContent = minutes + ' min';
            document.getElementById('timeSpentDisplay').textContent = minutes;
        }
        
        // Also poll Captivate for current slide every 2 seconds
        if (totalTimeSpent % 2 === 0) {
            pollCaptivateSlide();
        }
    }, 1000);
}

// Poll Captivate to check current slide (backup sync method)
let lastPolledSlide = 0;
function pollCaptivateSlide() {
    const iframe = document.getElementById('courseIframe');
    if (!iframe) return;
    
    try {
        const iframeWindow = iframe.contentWindow;
        
        // Try to read Captivate's current slide variable
        let captivateSlide = 0;
        
        // Method 1: cpInfoCurrentSlide (most common)
        if (typeof iframeWindow.cpInfoCurrentSlide !== 'undefined') {
            captivateSlide = parseInt(iframeWindow.cpInfoCurrentSlide) + 1; // Captivate is 0-indexed
        }
        // Method 2: cpAPIInterface
        else if (iframeWindow.cpAPIInterface && typeof iframeWindow.cpAPIInterface.getCurrentSlideIndex === 'function') {
            captivateSlide = iframeWindow.cpAPIInterface.getCurrentSlideIndex() + 1;
        }
        // Method 3: cp.movie
        else if (iframeWindow.cp && iframeWindow.cp.movie && typeof iframeWindow.cp.movie.cpInfoCurrentSlide !== 'undefined') {
            captivateSlide = parseInt(iframeWindow.cp.movie.cpInfoCurrentSlide) + 1;
        }
        
        // If Captivate reports a different slide than we're tracking, enforce and sync
        if (captivateSlide > 0 && captivateSlide !== lastPolledSlide) {
            lastPolledSlide = captivateSlide;
            lastKnownCaptivateSlide = captivateSlide;
            console.log('[LMS] Polled Captivate slide:', captivateSlide, 'Our slide:', currentSlide);
            onScormSlideChange(captivateSlide);
        }
    } catch (e) {
        // Cross-origin - can't poll, rely on SCORM
    }
}

	// Toggle fullscreen
	function toggleFullscreen() {
	    const playerContainer = document.getElementById('playerContainer');
	    if (getFullscreenElement()) {
	        exitFullScreen();
	        return;
	    }
	    enterFullScreen(playerContainer);
	}

// Save suspend_data (Captivate's internal resume state)
function saveSuspendData(suspendData) {
    fetch(progressUpdateUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            scorm_suspend_data: suspendData
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('[LMS] Suspend data saved');
    })
    .catch(error => console.error('[LMS] Failed to save suspend data:', error));
}

// Save progress to server
function saveProgress(extraPayload = {}) {
    const payload = Object.assign({
        current_slide: currentSlide,
        time_spent: Math.max(1, Math.floor((Date.now() - sessionStartTime) / 60000)),
        total_slides: totalSlides,
        content_completed: contentCompleted,
        scorm_suspend_data: scormData['cmi.suspend_data'] || ''
    }, extraPayload);

    return fetch(progressUpdateUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(payload)
    })
    .then(async response => {
        const data = await response.json().catch(() => ({}));
        return { ok: response.ok, data };
    })
    .then(({ ok, data }) => {
        if (ok && data && data.success) {
            syncFromServer(data);
        }
        return { ok, data };
    })
    .catch(error => {
        console.error('[LMS] Failed to save progress:', error);
        return { ok: false, data: { success: false, error: 'Network error while saving progress.' } };
    });
}

function syncFromServer(data) {
    if (!data) return;

    if (data.current_slide !== undefined) currentSlide = data.current_slide;
    if (data.highest_slide_reached !== undefined) highestSlideReached = data.highest_slide_reached;
    if (data.completion_percentage !== undefined) completionPercentage = data.completion_percentage;
    if (data.content_completed !== undefined) contentCompleted = data.content_completed;

    if (data.total_time_spent !== undefined) {
        document.getElementById('totalTimeSpent').textContent = data.total_time_spent + ' min';
        document.getElementById('timeSpentDisplay').textContent = data.total_time_spent;
    }

    updateProgressUI();
    updateSlideDisplay(currentSlide || highestSlideReached || 0);
    setNextButtonLabel();
}

function handleProgressError(data) {
    const message = (data && data.error) ? data.error : 'Could not save progress.';
    showToast('‚ö†Ô∏è Progress Not Saved', message, 'warning');

    if (data && data.current_slide) currentSlide = data.current_slide;
    if (data && data.highest_slide_reached !== undefined) highestSlideReached = data.highest_slide_reached;

    updateProgressUI();
    updateSlideDisplay(currentSlide || highestSlideReached || 0);
    setNextButtonLabel();

    if (currentSlide) goToCaptivateSlide(currentSlide);
    startSlideTimer();
}

// Update progress UI elements
function updateProgressUI() {
    document.getElementById('progressFill').style.width = completionPercentage + '%';
    document.getElementById('progressText').textContent = completionPercentage + '%';
    document.getElementById('progressPercent').textContent = completionPercentage + '%';
    
    const circle = document.getElementById('progressCircle');
    if (circle) {
        const circumference = 339.292;
        const offset = circumference - (completionPercentage / 100 * circumference);
        circle.style.strokeDashoffset = offset;
    }
    
    document.getElementById('currentSlideNum').textContent = currentSlide || highestSlideReached || 0;
    document.getElementById('slidesCompleted').textContent = highestSlideReached + ' / ' + totalSlides;
    
    const dots = document.querySelectorAll('.slide-dot');
    dots.forEach((dot, index) => {
        const slideNum = index + 1;
        dot.classList.remove('completed', 'current', 'locked');
        
        if (slideNum <= highestSlideReached) {
            dot.classList.add('completed');
        }
        if (slideNum === currentSlide) {
            dot.classList.add('current');
        }
        if (slideNum > highestSlideReached + 1) {
            dot.classList.add('locked');
        }
    });
}

// Show completion modal
function showCompletionModal() {
    $('#completionModal').modal('show');
}

// Show toast notification
function showToast(title, message, type = 'info') {
    const bgClass = {
        'success': 'bg-success',
        'error': 'bg-danger',
        'warning': 'bg-warning',
        'info': 'bg-info'
    }[type] || 'bg-info';
    
    const toast = $(`
        <div class="toast" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 320px;">
            <div class="toast-header ${bgClass} text-white">
                <strong class="mr-auto">${title}</strong>
                <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast">&times;</button>
            </div>
            <div class="toast-body bg-white">${message}</div>
        </div>
    `);
    
    $('body').append(toast);
    toast.toast({delay: 4000}).toast('show');
    toast.on('hidden.bs.toast', function() {
        toast.remove();
    });
}

// Listen for messages from iframe
window.addEventListener('message', function(event) {
    if (event.data && event.data.type) {
        console.log('[LMS] Message from iframe:', event.data);
        
        switch (event.data.type) {
            case 'slideChange':
                onScormSlideChange(event.data.slideNumber);
                break;
            case 'complete':
                onCourseCompleted();
                break;
        }
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateProgressUI();
    
    // Expose SCORM API on parent window
    window.API = createScormApi();
    window.API_1484_11 = createScorm2004Api();
    
    // Slide dot click handlers (info only)
    document.querySelectorAll('.slide-dot').forEach(dot => {
        dot.addEventListener('click', function() {
            const slideNum = parseInt(this.dataset.slide);
            if (slideNum <= highestSlideReached) {
                showToast('Slide ' + slideNum, 'This slide has been completed.', 'info');
            } else {
                showToast('üîí Slide Locked', 'Complete previous slides first.', 'warning');
            }
        });
    });

    // Mitigate browser back/forward attempts while in the player.
    try {
        history.pushState(null, document.title, location.href);
        window.addEventListener('popstate', function() {
            history.pushState(null, document.title, location.href);
            showToast('Navigation Blocked', 'Use the in-course controls to navigate.', 'warning');
        });
    } catch (e) {}
});

function handleFullscreenChange() {
    const isFullscreen = !!getFullscreenElement();
    const controls = document.getElementById('fullscreenControls');
    if (controls) controls.style.display = isFullscreen ? 'flex' : 'none';

    const fullscreenButton = document.getElementById('fullscreenBtn');
    if (fullscreenButton) {
        fullscreenButton.innerHTML = isFullscreen
            ? '<i class="fas fa-compress"></i>'
            : '<i class="fas fa-expand"></i>';
    }

    if (isFullscreen) {
        setTimeout(function() {
            scaleCaptivateToFullscreen(true);
        }, 250);
    } else {
        scaleCaptivateToFullscreen(false);
    }
}

document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
document.addEventListener('mozfullscreenchange', handleFullscreenChange);
document.addEventListener('MSFullscreenChange', handleFullscreenChange);

window.addEventListener('resize', function() {
    if (getFullscreenElement()) {
        scaleCaptivateToFullscreen(true);
    }
});

document.addEventListener('keydown', function(event) {
    if (!courseLaunched) return;
    if (!event || !event.key) return;
    if (event.key.toLowerCase() !== 'f') return;

    const target = event.target;
    if (target && typeof target.matches === 'function' && target.matches('input, textarea, select, [contenteditable="true"]')) {
        return;
    }

    event.preventDefault();
    toggleFullscreen();
});

// Save progress before leaving
window.addEventListener('beforeunload', function() {
    if (courseLaunched) {
        saveProgress();
    }
});

// Clean up
window.addEventListener('unload', function() {
    if (timeTracker) clearInterval(timeTracker);
    if (slideTimer) clearInterval(slideTimer);
});
</script>
{% endblock %}
