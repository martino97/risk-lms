{% extends 'base.html' %}
{% load static %}

{% block title %}Question Bank - {{ course.title }}{% endblock %}

{% block page_heading %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <div>
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-question-circle text-primary"></i> Question Bank
        </h1>
        <p class="mb-0 text-gray-600">{{ course.title }} - Assessment Questions</p>
    </div>
    <a href="{% url 'content:course_detail' course.id %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Course
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Course Info -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Course: {{ course.title }}</h6>
                </div>
                <div class="card-body">
                    <p>{{ course.description }}</p>
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Create assessment questions to test learner understanding. Minimum passing score: <strong>{{ course.passing_score }}%</strong>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Add New Question -->
        <div class="col-lg-5 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fas fa-plus"></i> Add New Question
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" id="questionForm">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            <label for="question_text" class="font-weight-bold">Question Text *</label>
                            <textarea class="form-control" id="question_text" name="question_text" 
                                      rows="3" placeholder="Enter your question here..." required></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="question_type" class="font-weight-bold">Question Type</label>
                                    <select class="form-control" id="question_type" name="question_type" required>
                                        <option value="multiple_choice">Multiple Choice</option>
                                        <option value="true_false">True/False</option>
                                        <option value="short_answer">Short Answer</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="topic" class="font-weight-bold">Topic</label>
                                    <input type="text" class="form-control" id="topic" name="topic" 
                                           placeholder="e.g., Credit Risk" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="difficulty" class="font-weight-bold">Difficulty</label>
                                    <select class="form-control" id="difficulty" name="difficulty">
                                        <option value="easy">Easy</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="hard">Hard</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="points" class="font-weight-bold">Points</label>
                                    <input type="number" class="form-control" id="points" name="points" 
                                           value="1" min="1" max="10">
                                </div>
                            </div>
                        </div>

                        <!-- Answer Options (for multiple choice) -->
                        <div id="optionsSection">
                            <label class="font-weight-bold">Answer Options</label>
                            <div id="optionsList">
                                <div class="input-group mb-2 option-item">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">
                                            <input type="radio" name="correct_option" value="0" required>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control option-text" placeholder="Option A" required>
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-danger remove-option" type="button">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="input-group mb-2 option-item">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">
                                            <input type="radio" name="correct_option" value="1" required>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control option-text" placeholder="Option B" required>
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-danger remove-option" type="button">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addOption">
                                <i class="fas fa-plus"></i> Add Option
                            </button>
                            <small class="form-text text-muted d-block mt-2">
                                Select the radio button next to the correct answer
                            </small>
                        </div>

                        <input type="hidden" id="optionsData" name="options">

                        <hr class="my-4">

                        <div class="form-group mb-0">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save"></i> Add Question
                            </button>
                            <button type="reset" class="btn btn-secondary btn-lg ml-2">
                                <i class="fas fa-redo"></i> Reset Form
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Existing Questions -->
        <div class="col-lg-7 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-list"></i> Course Questions ({{ questions.count }})
                    </h6>
                </div>
                <div class="card-body">
                    {% if questions %}
                        {% regroup questions by topic as questions_by_topic %}
                        {% for topic_group in questions_by_topic %}
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-tag"></i> {{ topic_group.grouper }}
                            </h6>
                            {% for question in topic_group.list %}
                            <div class="card border-left-info mb-3">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-2">{{ question.question_text }}</h6>
                                            <div class="mb-2">
                                                <span class="badge badge-secondary badge-sm">{{ question.get_question_type_display }}</span>
                                                <span class="badge badge-info badge-sm">{{ question.get_difficulty_display }}</span>
                                                <span class="badge badge-warning badge-sm">{{ question.points }} pts</span>
                                            </div>
                                            
                                            {% if question.question_type == 'multiple_choice' %}
                                            <div class="mt-2">
                                                <small class="text-muted">Options:</small>
                                                <ul class="list-unstyled ml-3 mb-0">
                                                    {% for option in question.options.all %}
                                                    <li class="small {% if option.is_correct %}text-success font-weight-bold{% endif %}">
                                                        {% if option.is_correct %}<i class="fas fa-check"></i>{% else %}<i class="far fa-circle"></i>{% endif %}
                                                        {{ option.option_text }}
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <div class="dropdown-menu dropdown-menu-right">
                                                <a class="dropdown-item text-danger" href="#" onclick="confirmDeleteQuestion({{ question.id }}, '{{ question.question_text|truncatechars:30|addslashes }}')">
                                                    <i class="fas fa-trash"></i> Delete Question
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-question-circle fa-5x text-gray-300 mb-3"></i>
                            <h4 class="text-gray-600">No Questions Yet</h4>
                            <p class="text-muted">Create your first assessment question using the form on the left</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let optionCount = 2;

document.getElementById('question_type').addEventListener('change', function() {
    const optionsSection = document.getElementById('optionsSection');
    if (this.value === 'multiple_choice') {
        optionsSection.style.display = 'block';
    } else {
        optionsSection.style.display = 'none';
    }
});

document.getElementById('addOption').addEventListener('click', function() {
    const optionsList = document.getElementById('optionsList');
    const optionHtml = `
        <div class="input-group mb-2 option-item">
            <div class="input-group-prepend">
                <div class="input-group-text">
                    <input type="radio" name="correct_option" value="${optionCount}" required>
                </div>
            </div>
            <input type="text" class="form-control option-text" placeholder="Option ${String.fromCharCode(65 + optionCount)}" required>
            <div class="input-group-append">
                <button class="btn btn-outline-danger remove-option" type="button">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
        </div>
    `;
    optionsList.insertAdjacentHTML('beforeend', optionHtml);
    optionCount++;
    updateRemoveButtons();
});

function updateRemoveButtons() {
    const removeButtons = document.querySelectorAll('.remove-option');
    removeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            if (document.querySelectorAll('.option-item').length > 2) {
                this.closest('.option-item').remove();
                updateRadioValues();
            } else {
                alert('A question must have at least 2 options');
            }
        });
    });
}

function updateRadioValues() {
    const optionItems = document.querySelectorAll('.option-item');
    optionItems.forEach((item, index) => {
        const radio = item.querySelector('input[type="radio"]');
        radio.value = index;
    });
}

document.getElementById('questionForm').addEventListener('submit', function(e) {
    const questionType = document.getElementById('question_type').value;
    
    if (questionType === 'multiple_choice') {
        const options = [];
        const optionItems = document.querySelectorAll('.option-item');
        const correctOption = document.querySelector('input[name="correct_option"]:checked');
        
        if (!correctOption) {
            e.preventDefault();
            alert('Please select the correct answer');
            return;
        }
        
        optionItems.forEach((item, index) => {
            const text = item.querySelector('.option-text').value.trim();
            if (text) {
                options.push({
                    text: text,
                    is_correct: index == correctOption.value
                });
            }
        });
        
        document.getElementById('optionsData').value = JSON.stringify(options);
    }
});

function deleteQuestion(questionId) {
    if (confirm('Are you sure you want to delete this question?')) {
        // Implement delete functionality
        alert('Delete functionality would be implemented here');
    }
}

function confirmDeleteQuestion(questionId, questionText) {
    if (confirm(`Are you sure you want to delete this question?\n\n"${questionText}..."\n\nThis action cannot be undone.`)) {
        // Delete question via AJAX
        fetch(`/content/question/${questionId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload(); // Refresh page to show updated question list
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the question.');
        });
    }
}

// Initialize
updateRemoveButtons();
</script>
{% endblock %}